rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /users/{userId} {
      // Admins can read and write all user profiles
      // Employees can only read their own profile
      allow read: if isAdmin() || request.auth.uid == userId;
      allow write: if isAdmin();
      allow create: if isAdmin();
    }
    
    match /dailyLogs/{logId} {
      // Employees can create their own logs.
      allow create: if isAuthenticated() && request.resource.data.employeeId == request.auth.uid;
      // Only admins can read all logs. (Employees see aggregated data, not individual docs)
      allow read: if isAdmin();
      // Logs are immutable.
      allow update, delete: if false;
    }

    match /tasks/{taskId} {
      // Admins can create tasks.
      allow create: if isAdmin();
      // Employees can read their own tasks, Admins can read all.
      allow read: if isAdmin() || (isAuthenticated() && get(/databases/$(database)/documents/tasks/$(taskId)).data.employeeId == request.auth.uid);
      // Employees can update their own tasks (e.g., mark as complete)
      allow update: if isAuthenticated() && request.resource.data.employeeId == request.auth.uid;
      // Only admins can delete tasks.
      allow delete: if isAdmin();
    }

    match /resources/{resourceId} {
      // Any authenticated user can read resources.
      allow read: if isAuthenticated();
      // Only admins can create, update, or delete resources.
      allow write: if isAdmin();
    }

    match /announcements/{docId} {
        // Any authenticated user can read announcements
        allow read: if isAuthenticated();
        // Only admins can write announcements
        allow write: if isAdmin();
    }

    match /visitorLogs/{logId} {
        // Only admins can read visitor logs
        allow read: if isAdmin();
        // Any authenticated user can create a log for themselves
        allow create: if isAuthenticated() && request.resource.data.employeeId == request.auth.uid;
    }

    match /fakeEmployees/{employeeId} {
        // Any authenticated user can read the fake employee list
        allow read: if isAuthenticated();
        // Only admins can write to the fake employee list
        allow write: if isAdmin();
    }

    match /taskFields/{fieldId} {
        // Any authenticated user can read the task fields to build the form
        allow read: if isAuthenticated();
        // Only admins can create, update, and delete task fields
        allow write: if isAdmin();
    }
    
    match /config/{configId} {
        // Any authenticated user can read the config (needed for webhook URL)
        allow read: if isAuthenticated();
        // Only admins can write to config
        allow write: if isAdmin();
    }
  }
}